# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.
parameters:
    filePattern: null
    inlineSignParams: null
    signedArtifactName: null
    platform: null

steps:
    - task: SFP.build-tasks.custom-build-task-1.EsrpCodeSigning@1
      displayName: 'ESRP signing installer'
      inputs:
          ConnectedServiceName: 'ESRP Code Signing'
          FolderPath: '$(System.DefaultWorkingDirectory)/signing-in-progress/${{ parameters.signedArtifactName }}/packed'
          Pattern: ${{ parameters.filePattern }}
          signConfigType: inlineSignParams
          inlineOperation: ${{ parameters.inlineSignParams }}

    - task: securedevelopmentteam.vss-secure-development-tools.build-task-codesignvalidation.CodeSign@1
      displayName: codesign validation
      condition: and(succeeded(), eq(variables.platform, 'windows'))
      inputs:
          Path: $(System.DefaultWorkingDirectory)
          Targets: +:f|signing-in-progress/**.exe;+:f|drop/electron/unified-${{ parameters.channel }}/packed/win-unpacked/**.dll;drop/electron/unified-${{ parameters.channel }}/packed/win-unpacked/**.exe;
          ExcludePassesFromLog: false

    - script: node ./pipeline/scripts/update-latest-yml.js signing-in-progress/${{ parameters.signedArtifactName }}/packed ${{ parameters.platform }}
      displayName: update electron-builder latest.yml after signing

    - template: ../publish-packed-build-output.yaml
      parameters:
          packedOutputPath: '$(System.DefaultWorkingDirectory)/signing-in-progress/${{ parameters.signedArtifactName }}/packed'
          artifactName: ${{ parameters.signedArtifactName }}
