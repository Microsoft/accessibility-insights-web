# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.
steps:
    - script: yarn copy:prepare-binskim
      displayName: prepare for BinSkim
      condition: and(succeeded(), eq(variables.platform, 'windows'))

    - task: NuGetToolInstaller@1
      displayName: Install NuGet 5.x
      condition: and(succeeded(), eq(variables.platform, 'windows'))
      inputs:
          versionSpec: '5.x'

    - task: NuGetCommand@2
      displayName: Install BinSkim package from NuGet
      condition: and(succeeded(), eq(variables.platform, 'windows'))
      inputs:
          command: custom
          arguments: 'install Microsoft.CodeAnalysis.BinSkim -NonInteractive -Source https://api.nuget.org/v3/index.json -OutputDirectory $(Agent.BuildDirectory)'

    - script: node pipeline/scripts/run-binskim.js $(Agent.BuildDirectory)
      displayName: run-binskim
      condition: and(succeeded(), eq(variables.platform, 'windows'))

    - task: CopyFiles@2
      displayName: copy BinSkim results
      condition: and(succeeded(), eq(variables.platform, 'windows'))
      inputs:
          SourceFolder: '$(Agent.BuildDirectory)/BinSkim/Logs'
          TargetFolder: '$(System.ArtifactStagingDirectory)/CodeAnalysisLogs'

    - task: PublishBuildArtifacts@1
      displayName: publish CodeAnalysisLogs
      condition: and(succeeded(), eq(variables.platform, 'windows'))
      inputs:
          pathtoPublish: '$(System.ArtifactStagingDirectory)/CodeAnalysisLogs'
          artifactName: 'CodeAnalysisLogs'
