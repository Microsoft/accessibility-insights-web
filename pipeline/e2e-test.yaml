# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.
steps:
    # e2e tests depend drop folder. run build:all will create said folder
    - script: yarn build:all
      displayName: build:all

    - script: docker build -t app .
      condition: eq( variables['Agent.OS'], 'Linux' )
      displayName: setup docker on linux

    - bash: |
          export CONTAINERID=$(docker ps -alq)
          echo "##vso[task.setvariable variable=CONTAINER_ID]$CONTAINERID"
      condition: eq( variables['Agent.OS'], 'Linux' )
      displayName: get container id for docker on Linux

    - script: docker run --network=host -i app
      condition: eq( variables['Agent.OS'], 'Linux' )
      displayName: run e2e tests on linux

    - script: docker cp $(CONTAINER_ID):/app/test-results/ .
      condition: eq( variables['Agent.OS'], 'Linux' )
      displayName: copy test results

    - script: yarn test:e2e -- --ci
      condition: eq( variables['Agent.OS'], 'Windows_NT' )
      displayName: run e2e tests
